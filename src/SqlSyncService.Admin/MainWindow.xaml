<Window x:Class="SqlSyncService.Admin.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="SqlSyncService Administration"
        Height="700" Width="1000"
        WindowStartupLocation="CenterScreen"
        Background="{StaticResource BackgroundBrush}"
        Loaded="Window_Loaded">
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="{StaticResource PrimaryBrush}" Padding="24,20">
            <Grid>
                <StackPanel>
                    <TextBlock Text="SqlSyncService Administration" 
                               FontSize="22" 
                               FontWeight="Bold" 
                               Foreground="White"/>
                    <TextBlock Text="Manage service configuration, queries, and security settings" 
                               FontSize="13" 
                               Foreground="White" 
                               Opacity="0.9"
                               Margin="0,4,0,0"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Status/Alert Bar -->
        <Border x:Name="AlertPanel" 
                Grid.Row="0"
                Margin="24,-10,24,0"
                Background="{StaticResource SuccessBrush}"
                CornerRadius="6"
                Padding="16,12"
                Visibility="Collapsed"
                VerticalAlignment="Bottom">
            <Grid>
                <TextBlock x:Name="AlertText" 
                           Text="Success message"
                           Foreground="White"
                           FontWeight="SemiBold"
                           TextWrapping="Wrap"/>
                <Button Content="✕" 
                        HorizontalAlignment="Right"
                        Background="Transparent"
                        Foreground="White"
                        BorderThickness="0"
                        FontSize="16"
                        Cursor="Hand"
                        Click="CloseAlert_Click"/>
            </Grid>
        </Border>

        <!-- Main Content -->
        <TabControl Grid.Row="1" Margin="0,20,0,0" x:Name="MainTabs">
            <!-- Security Tab -->
            <TabItem Header="🔒 Security">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="24" MaxWidth="800">
                        <TextBlock Text="Security Configuration" 
                                   FontSize="18" 
                                   FontWeight="Bold"
                                   Foreground="{StaticResource TextPrimaryBrush}"
                                   Margin="0,0,0,20"/>

                        <!-- API Key Section -->
                        <Border Background="{StaticResource SurfaceBrush}" 
                                CornerRadius="8" 
                                Padding="20"
                                Margin="0,0,0,16">
                            <StackPanel>
                                <TextBlock Text="API Key" 
                                           FontSize="16" 
                                           FontWeight="SemiBold"
                                           Margin="0,0,0,12"/>
                                
                                <TextBlock Text="Current API key is encrypted for security." 
                                           Foreground="{StaticResource TextSecondaryBrush}"
                                           Margin="0,0,0,12"/>
                                
                                <Button Content="🔄 Generate New API Key" 
                                        Style="{StaticResource PrimaryButton}"
                                        HorizontalAlignment="Left"
                                        Click="RotateApiKey_Click"/>
                            </StackPanel>
                        </Border>

                        <!-- IP Allow List Section -->
                        <Border Background="{StaticResource SurfaceBrush}" 
                                CornerRadius="8" 
                                Padding="20"
                                Margin="0,0,0,16">
                            <StackPanel>
                                <TextBlock Text="IP Allow List" 
                                           FontSize="16" 
                                           FontWeight="SemiBold"
                                           Margin="0,0,0,12"/>
                                
                                <TextBlock Text="Only requests from these IP addresses will be accepted." 
                                           Foreground="{StaticResource TextSecondaryBrush}"
                                           Margin="0,0,0,12"/>

                                <ListBox x:Name="IpListBox" 
                                         MinHeight="100" 
                                         MaxHeight="200"
                                         Margin="0,0,0,12"/>

                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <TextBox x:Name="NewIpTextBox" 
                                            Grid.Column="0"
                                            Margin="0,0,8,0"
                                            KeyDown="NewIpTextBox_KeyDown"/>
                                    <Button Grid.Column="1" 
                                            Content="Add IP" 
                                            Style="{StaticResource PrimaryButton}"
                                            Click="AddIp_Click"
                                            Margin="0,0,8,0"/>
                                    <Button Grid.Column="2" 
                                            Content="Remove" 
                                            Style="{StaticResource DangerButton}"
                                            Click="RemoveIp_Click"/>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <!-- Certificate Section -->
                        <Border Background="{StaticResource SurfaceBrush}" 
                                CornerRadius="8" 
                                Padding="20">
                            <StackPanel>
                                <TextBlock Text="HTTPS Certificate" 
                                           FontSize="16" 
                                           FontWeight="SemiBold"
                                           Margin="0,0,0,12"/>
                                
                                <Label Content="Certificate Path (.pfx):"/>
                                <Grid Margin="0,0,0,12">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBox x:Name="CertPathTextBox" Grid.Column="0" Margin="0,0,8,0"/>
                                    <Button Grid.Column="1" Content="Browse..." Click="BrowseCert_Click"/>
                                </Grid>

                                <Button Content="✓ Validate Certificate" 
                                        Style="{StaticResource SuccessButton}"
                                        HorizontalAlignment="Left"
                                        Click="ValidateCert_Click"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Database Tab -->
            <TabItem Header="🗄️ Database">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="24" MaxWidth="800">
                        <TextBlock Text="Database Configuration" 
                                   FontSize="18" 
                                   FontWeight="Bold"
                                   Foreground="{StaticResource TextPrimaryBrush}"
                                   Margin="0,0,0,20"/>

                        <Border Background="{StaticResource SurfaceBrush}" 
                                CornerRadius="8" 
                                Padding="20">
                            <StackPanel>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <StackPanel Grid.Column="0" Margin="0,0,8,0">
                                        <Label Content="Server:"/>
                                        <TextBox x:Name="DbServerTextBox" Margin="0,0,0,12"/>
                                    </StackPanel>
                                    
                                    <StackPanel Grid.Column="1" Margin="8,0,0,0">
                                        <Label Content="Port:"/>
                                        <TextBox x:Name="DbPortTextBox" Margin="0,0,0,12"/>
                                    </StackPanel>
                                </Grid>

                                <Label Content="Database Name:"/>
                                <TextBox x:Name="DbNameTextBox" Margin="0,0,0,12"/>

                                <Label Content="Instance (optional):"/>
                                <TextBox x:Name="DbInstanceTextBox" Margin="0,0,0,12"/>

                                <Border Background="#fef3c7" 
                                        BorderBrush="#fcd34d"
                                        BorderThickness="1"
                                        CornerRadius="6"
                                        Padding="12"
                                        Margin="0,0,0,12">
                                    <TextBlock Text="⚠️ Database credentials are stored encrypted using Windows DPAPI. Changes to credentials require service restart."
                                               Foreground="#92400e"
                                               TextWrapping="Wrap"/>
                                </Border>

                                <Button Content="🔌 Test Database Connection" 
                                        Style="{StaticResource SuccessButton}"
                                        HorizontalAlignment="Left"
                                        Click="TestConnection_Click"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Queries Tab -->
            <TabItem Header="📝 Queries">
                <Grid Margin="24">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0" Margin="0,0,0,16">
                        <TextBlock Text="Query Definitions" 
                                   FontSize="18" 
                                   FontWeight="Bold"
                                   Foreground="{StaticResource TextPrimaryBrush}"
                                   Margin="0,0,0,8"/>
                        <TextBlock Text="Define SQL queries that will be executed via API endpoints." 
                                   Foreground="{StaticResource TextSecondaryBrush}"
                                   Margin="0,0,0,12"/>
                        <Button Content="➕ Add New Query" 
                                Style="{StaticResource PrimaryButton}"
                                HorizontalAlignment="Left"
                                Click="AddQuery_Click"/>
                    </StackPanel>

                    <DataGrid x:Name="QueriesDataGrid" 
                              Grid.Row="1"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              SelectionMode="Single"
                              HeadersVisibility="Column"
                              Background="{StaticResource SurfaceBrush}"
                              MouseDoubleClick="QueriesDataGrid_MouseDoubleClick">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="150"/>
                            <DataGridCheckBoxColumn Header="Paginable" Binding="{Binding Paginable}" Width="80"/>
                            <DataGridTextColumn Header="Mode" Binding="{Binding PaginationMode}" Width="100"/>
                            <DataGridTextColumn Header="OrderBy/KeyColumns" Binding="{Binding OrderByOrKeys}" Width="*"/>
                            <DataGridTemplateColumn Header="Actions" Width="120">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Button Content="Edit" Margin="0,0,4,0" Click="EditQuery_Click"/>
                                            <Button Content="Delete" Click="DeleteQuery_Click"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </TabItem>

            <!-- Mapping Tab -->
            <TabItem Header="🔗 Mapping">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="24" MaxWidth="900">
                        <TextBlock Text="Endpoint Mapping" 
                                   FontSize="18" 
                                   FontWeight="Bold"
                                   Foreground="{StaticResource TextPrimaryBrush}"
                                   Margin="0,0,0,8"/>
                        <TextBlock Text="Map queries to API endpoints and specify target JSON arrays." 
                                   Foreground="{StaticResource TextSecondaryBrush}"
                                   Margin="0,0,0,16"/>

                        <Border Background="#fef3c7" 
                                BorderBrush="#fcd34d"
                                BorderThickness="1"
                                CornerRadius="6"
                                Padding="12"
                                Margin="0,0,0,16">
                            <TextBlock Text="⚠️ Mappings are validated against integration.json schema at startup."
                                       Foreground="#92400e"
                                       TextWrapping="Wrap"/>
                        </Border>

                        <ListBox x:Name="MappingListBox" 
                                 MinHeight="400"
                                 Background="{StaticResource SurfaceBrush}"/>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- About Tab -->
            <TabItem Header="ℹ️ About">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="24" MaxWidth="800">
                        <TextBlock Text="About SqlSyncService" 
                                   FontSize="18" 
                                   FontWeight="Bold"
                                   Foreground="{StaticResource TextPrimaryBrush}"
                                   Margin="0,0,0,20"/>

                        <Border Background="{StaticResource SurfaceBrush}" 
                                CornerRadius="8" 
                                Padding="20">
                            <StackPanel>
                                <TextBlock Text="Version: 1.0.0" 
                                           FontSize="14" 
                                           Margin="0,0,0,8"/>
                                <TextBlock Text="Platform: .NET 8.0 Windows Service" 
                                           FontSize="14" 
                                           Margin="0,0,0,8"/>
                                <TextBlock x:Name="ListenUrlText" 
                                           Text="Listen Address: https://0.0.0.0:8443" 
                                           FontSize="14" 
                                           Margin="0,0,0,8"/>
                                <TextBlock x:Name="ConfigDirText" 
                                           Text="Config Directory: C:\ProgramData\SqlSyncService" 
                                           FontSize="14" 
                                           Margin="0,0,0,20"/>
                                
                                <Separator Margin="0,0,0,16"/>
                                
                                <TextBlock Text="Features:" 
                                           FontWeight="SemiBold" 
                                           Margin="0,0,0,8"/>
                                <TextBlock Text="✓ HTTPS API on port 8443" Margin="0,0,0,4"/>
                                <TextBlock Text="✓ SQL Server connectivity with SQL Login" Margin="0,0,0,4"/>
                                <TextBlock Text="✓ IP allow-list and API key authentication" Margin="0,0,0,4"/>
                                <TextBlock Text="✓ DPAPI encryption for secrets" Margin="0,0,0,4"/>
                                <TextBlock Text="✓ Offset and token-based pagination" Margin="0,0,0,4"/>
                                <TextBlock Text="✓ JSON streaming for large datasets" Margin="0,0,0,4"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
        </TabControl>

        <!-- Footer -->
        <Border Grid.Row="2" 
                Background="{StaticResource SurfaceBrush}" 
                BorderBrush="#e5e7eb"
                BorderThickness="0,1,0,0"
                Padding="24,16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0" 
                           Text="💾 Remember to restart the service after saving configuration changes." 
                           Foreground="{StaticResource TextSecondaryBrush}"
                           VerticalAlignment="Center"/>

                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Content="💾 Save Configuration" 
                            Style="{StaticResource SuccessButton}"
                            Click="SaveConfig_Click"
                            Margin="0,0,8,0"
                            Height="40"
                            Width="180"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
